name: create-polkadot-release-ticket

on:
  workflow_dispatch:
    inputs:
      current-version:
        description: Current version of the Polkadot/Cumulus dependency
        required: true
        type: string
      target-version:
        description: Target version of the Polkadot/Cumulus dependency
        required: true
        type: string
      asignee:
        description: Person assigned for this upgrade
        required: false
        default: weichweich
        type: choice
        options:
        - weichweich
        - ntn-x2
        - trusch
        - Ad96el

jobs:
  create-ticket:
    runs-on: ubuntu-latest
    steps:
      - name: Install cargo
        run: curl https://sh.rustup.rs -sSf | sh
      - name: Install subalfred
        env:
          - SUBALFRED_VERSION: 0.9.1
        run: cargo install --version $SUBALFRED_VERSION --git https://github.com/hack-ink/subalfred.git subalfred
      - name: Run subalfred for Substrate
        run: subalfred track-updates paritytech/substrate --from polkadot-v${{ inputs.current-version }} --to polkadot-v${{ inputs.target-version }} > substrate-out.md
      - name: Run subalfred for Cumulus
        run: subalfred track-updates paritytech/cumulus --from polkadot-v${{ inputs.current-version }} --to polkadot-v${{ inputs.target-version }} > cumulus-out.md
      - name: Merge outputs into single file
        run: |
          echo "## Substrate changes" > out.md
          cat substrate-out.md >> out.md
          echo "## Cumulus changes" >> out.md
          cat cumulus-out.md >> out.md
      - name: Create issue from commands output
        id: new-issue
        uses: peter-evans/create-issue-from-file@v3
        with:
          title: "chore: update Polkadot dependencies from ${{ inputs.current-version }} to ${{ inputs.target-version }}"
          repository: KILTProtocol/ticket
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          content-filepath: out.md
      - name: Put issue into weekly board
        uses: peter-evans/create-or-update-project-card@v2
        with:
          # Weekly board
          project-number: 24
          column-name: "ðŸ“¥  Inbox"
          issue-number: ${{ steps.new-issue.outputs.issue-number }}

