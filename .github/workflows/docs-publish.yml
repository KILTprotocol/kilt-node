name: Deploy rustdoc

on:
  push:
    branches:
      - develop
      - 'refs/tags/[0-9]+.[0-9]+.[0-9]+*'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true

      - name: Checkout
        uses: actions/checkout@v4

      - name: Run cargo doc
        run: |
          docker run --rm \
            -v "${GITHUB_WORKSPACE}:/workspace" \
            -v "${HOME}/.cargo:/root/.cargo" \
           -e RUSTDOCFLAGS='-D warnings' \
            -w /workspace \
            paritytech/ci-unified:bullseye-1.74.0 \
            bash -c "cargo doc --all-features --no-deps --locked && \
              chown -R $(id -u):$(id -g) target/doc"

      - name: Deploy
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: target/doc
