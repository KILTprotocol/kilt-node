name: Create Polkadot version upgrade ticket

on:
  workflow_dispatch:
    inputs:
      current-version:
        description: Current version of the Polkadot/Cumulus dependency
        required: true
        type: string
      target-version:
        description: Target version of the Polkadot/Cumulus dependency
        required: true
        type: string
      assignee:
        description: Person assigned for this upgrade
        required: false
        default: weichweich
        type: choice
        options:
        - weichweich
        - ntn-x2
        - trusch
        - Ad96el

jobs:
  create-ticket:
    runs-on: ubuntu-latest
    container:
      image: rust:1.67.0
    steps:
      - name: Install subalfred
        env:
          SUBALFRED_VERSION: 0.9.1
        run: cargo install --version $SUBALFRED_VERSION --git https://github.com/hack-ink/subalfred.git subalfred
      - name: Run subalfred for Substrate
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: subalfred track-updates paritytech/substrate --from polkadot-v${{ inputs.current-version }} --to polkadot-v${{ inputs.target-version }} > substrate-out.md
      - name: Run subalfred for Cumulus
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: subalfred track-updates paritytech/cumulus --from polkadot-v${{ inputs.current-version }} --to polkadot-v${{ inputs.target-version }} > cumulus-out.md
      - name: Merge outputs into single file
        run: |
          echo "## Substrate changes" > out.md
          cat substrate-out.md >> out.md
          echo "## Cumulus changes" >> out.md
          cat cumulus-out.md >> out.md
      - name: Create issue from commands output
        id: new-issue
        uses: peter-evans/create-issue-from-file@v3
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        with:
          title: "[AUTOMATIC] Update Polkadot dependencies from ${{ inputs.current-version }} to ${{ inputs.target-version }}"
          repository: KILTProtocol/kilt-node
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          content-filepath: out.md
          labels: kiltbot,â›“ KILT node
          assignees: ${{ github.event.inputs.assignee }}

