test:
  extends: .check_skip_rust
  timeout: 2 hours
  image: paritytech/ci-unified:bullseye-1.77.0
  stage: test
  cache:
    key: cache-test
    paths:
      - target/
      - .cargo/bin/
      - .cargo/registry/index/
      - .cargo/registry/cache/
      - .cargo/git/db/
  script:
    - cargo test --all --all-targets --locked

test-features:
  extends: .check_skip_rust
  timeout: 2 hours
  image: paritytech/ci-unified:bullseye-1.77.0
  stage: test
  needs:
    - test
  cache:
    key: cache-test
    paths:
      - target/
      - .cargo/bin/
      - .cargo/registry/index/
      - .cargo/registry/cache/
      - .cargo/git/db/
  script:
    - cargo test --all --all-features --all-targets --locked

integration-tests:
  extends: .check_skip_integration_tests
  timeout: 30 minutes
  image: paritytech/ci-unified:bullseye-1.77.0
  stage: test
  cache:
    key: cache-integration-tests
    paths:
      - ./integration-tests/chopsticks/node_modules
  variables:
    CI: "true"
  script:
    - cd ./integration-tests/chopsticks
    - curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
    - export NVM_DIR="$HOME/.nvm" && . "$NVM_DIR/nvm.sh" --no-use
    - eval "[ -f .nvmrc ] && nvm install" && nvm use
    - yarn --immutable
    - yarn ts-check
    - yarn lint
    - yarn test:CI

test-try-runtime:
  parallel:
    matrix:
      - RUNTIME: "peregrine"
        ENDPOINT: "wss://peregrine.kilt.io:443"
      - RUNTIME: "spiritnet"
        ENDPOINT: "wss://spiritnet.kilt.io:443"
  image: paritytech/ci-unified:bullseye-1.77.0
  stage: test
  only:
    - develop
    - master
    - /^[0-9]+(?:\.[0-9]+){2}(?:-(rc)*([0-9])+)?$/
  variables:
    TRY_RUNTIME_CLI_VERSION_TAG: v0.7.0
  script:
    # Build
    - cargo build --release -p ${RUNTIME}-runtime --features try-runtime
    - mkdir ./out
    - mv target/release/wbuild/${RUNTIME}-runtime/${RUNTIME}_runtime.compact.compressed.wasm ./dangerous_${RUNTIME}.try-runtime.wasm
    # Test
    - cargo install --git https://github.com/paritytech/try-runtime-cli --tag ${TRY_RUNTIME_CLI_VERSION_TAG} --locked
    - ./.cargo/bin/try-runtime --version
    - ./try-runtime --runtime ./dangerous_${RUNTIME}.try-runtime.wasm on-runtime-upgrade --disable-spec-version-check --checks=all live --uri=${ENDPOINT}
