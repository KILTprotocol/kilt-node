stages:
  - lint
  - test
  - build

clippy:
  image: paritytech/ci-linux:9a44d4ec-20210423
  stage: lint
  timeout: 1 hours
  script:
    - rustup component add clippy --toolchain nightly
    - cargo +nightly clippy -- -D warnings

fmt:
  image: paritytech/ci-linux:9a44d4ec-20210423
  stage: lint
  timeout: 1 hours
  script:
    - rustup component add rustfmt
    - cargo fmt -- --check

test:
  image: paritytech/ci-linux:9a44d4ec-20210423
  stage: test
  timeout: 1 hours
  script:
    - cargo test --all --all-features

build-fast-gov:
  image: docker:19.03.12
  stage: build
  script:
    - docker build --build-arg NODE_TYPE=kilt-parachain --build-arg FEATURES=fast-gov -t kiltprotocol/peregrine:latest-fast-gov .
    - docker save kiltprotocol/peregrine:latest-fast-gov > peregrine-latest-fast-gov.img
  artifacts:
    paths:
      - peregrine-latest-fast-gov.img

build:
  image: docker:19.03.12
  stage: build
  only:
    - master
    - develop
  script:
    - docker build --build-arg NODE_TYPE=kilt-parachain -t kiltprotocol/peregrine:develop .
    - docker save kiltprotocol/peregrine:develop > peregrine-develop.img
    - docker build --build-arg NODE_TYPE=mashnet-node -t kiltprotocol/mashnet-node:develop .
    - docker save kiltprotocol/mashnet-node:develop > mashnet-node-develop.img
  artifacts:
    paths:
      - peregrine-develop.img
      - mashnet-node-develop.img
